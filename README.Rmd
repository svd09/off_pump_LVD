---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```

### Off-pump coronary artery bypass grafting is safe and effective in patients with severe left ventricular dysfunction

Authors: Mateo Marin-Cuartas^1^, Salil V. Deo^2^, Paulina Ramirez^1^, Alexander Verevkin^1^, Sergey Leontyev^1^, Michael A. Borger^1^, Piroze M. Davierwala^1^

<u>Affiliations:</u>


- ^1^ University Department of Cardiac Surgery, Heart Center Leipzig, Leipzig, Germany, ^2^ Louis Stokes Cleveland VA Medical Center, Department of Veterans Affairs, Cleveland Ohio, United States of America.

<u>Corresponding Author:</u>

Dr. Piroze M. Davierwala,

University Department of Cardiac Surgery,Heart Center Leipzig,Struempellstrasse 39,
04289 Leipzig, Germany

Email: pirarm@hotmail.com


```{r, echo = F, message = F, warning=F}

library(easypackages)
libraries(c("survival","tidyverse","plotly",
            "rms",'Hmisc',"ggthemes", "haven","readxl",
            "survminer"))

```

<u>Figures presented in the manuscript are recreated and presented here as interactive graphs.</u>

<u>Main Manuscript:</u>

Figure 1.

```{r, echo=FALSE,warning=FALSE,message=FALSE}


df <- read_csv("D:/opcab/opcab_paper/long_term_results/dataset_latest.csv")


dfs <- read_excel("D:/opcab/opcab_paper/propensity_model/raw_data.xlsx",sheet = 1)

dfs2 <- dfs %>% dplyr::select(Pat_ID, Surgeon_name)


dfs2 <- dfs2[!duplicated(dfs2$Pat_ID), ]


s_count <- dfs2 %>% group_by(Surgeon_name) %>% summarise(total = n())

# list of low:- 

s_l <- s_count %>% filter(total <= 30)

s_m <- s_count %>% filter(total > 30 & total <= 60)

s_h <- s_count %>% filter(total > 60)

# now add the surgeon_names to the main dataset.

names(dfs2) <- tolower(names(dfs2))

dfs2$pat_id = as.numeric(dfs2$pat_id)

df2 <- left_join(df, dfs2, by = "pat_id")


df2$type <- with(df2, ifelse(surgeon_name %in% s_l$Surgeon_name, 1,
                             ifelse(surgeon_name %in% s_m$Surgeon_name, 2, 3)))

# while none missing, preop_mi has -9 and bmi needs to change.

df2$preop_mi[df2$preop_mi == -9] <- 001

df2$bmi[df2$bmi == 94] <- 49

# now to use all these variables and create a model for propensity score.


formula <- opcab ~ age_at_surgery + gender + bmi + diabetes +
  dialysis_dependence + systemic_hypertension + smoker + hyperlipidemia +
  copd + peripheral_vascular_disease + preop_lvef + elective + type +  
  urgent + emergency + left_main_disease + preop_mi + preop_cva + prior_cardiac_surgery + logistic_euroscore +
  coronary_disease_detail

psmodel <- glm(formula, data = df2, family = "binomial"(link = "logit"))

df2$ps <- fitted.values(psmodel)


library(tidyverse)
library(plotly)


d <- df2 %>% dplyr::select(opcab, ps)

d0 = d %>% filter(opcab == 0)

d1 = d %>% filter(opcab == 1)


a <- d0 %>% 
  plot_ly(type = "histogram", x = ~ ps,
          color = I("blue"), alpha = 0.6,stroke = I("black")) %>%
  layout(title = "Propensity Scores: Mirror Histogram",
         xaxis = list(range = c(0,1)),
         showlegend = F) %>%
  add_annotations(text = "<b>ONCAB</b>",
                  x = 0.8, y = 20,
                  showarrow = F)



b <-  d1 %>%
  plot_ly(type = "histogram", x = ~ ps,
          color = I("red"), alpha = 0.6, stroke = I("black")) %>%
  layout(yaxis = list(autorange = "reversed"),
         xaxis = list(title = "Propensity Scores",
                      range = c(0,1)),
         showlegend = F) %>%
  add_annotations(text = "<b>OPCAB</b>",
                  x = 0.8, y = 20,
                  showarrow = F)
  

plotly::subplot(a,b, nrows = 2, shareX = T,
titleX = T, titleY = T)


```


<u>Figure 2 A:</u>

```{r insert the code for plotly survival figure here, echo=FALSE,message=FALSE,warning=FALSE}

plotly_survival <- function(ggsurvplot, strata_colours="Set1", plot_title="",
                            xaxis=list(title="time",
                                       hoverformat=".2f"),
                            yaxis=list(title="survival", 
                                       hoverformat= ".2f"),
                            legend=list(),
                            plot_CIs=TRUE,
                            CI_opacity=0.25,
                            CI_linewidth=0,
                            censor_symbol="line-ns-open",
                            censor_size=10,
                            showlegend_surv=TRUE,
                            showlegend_censor=FALSE,
                            showlegend_CI=TRUE,
                            showlegend_all=TRUE){
  
  # coerce to ggsurvplot where possible (will work for survfit objects)
  if(class(ggsurvplot)[1] != "ggsurvplot"){
    ggsurvplot <- ggsurvplot(ggsurvplot)
  }
  
  # defaults (can probably do something clever by combining lists so that users don't have to redefine e.g.
  # hoverinfo if they specifiy another xaxis attribute)
  # xaxis_default = list(title="time",
  #            hoverformat=".2f")
  # xaxis <- c(xaxis, xaxis_default)
  
  
  # extract survival data from ggsurvplot object
  df <- ggsurvplot$data.survplot
  df <- as.data.frame(df)[order(df$time), ]
  strata_name_if_no_strata <- "all"
  
  # number of strata in plot (e.g. 1 if no breakdown variable)
  num_of_strata <- ifelse(any(names(df)=="strata") == TRUE,
                          length(unique(df$strata)), 
                          1)
  
  # vector containing the names of the strata (for legend labels etc)
  if (num_of_strata > 1) {
    names_of_strata <- as.character(unique(df$strata))
  } else {
    names_of_strata <- strata_name_if_no_strata
    df$strata <- strata_name_if_no_strata
  }
  
  
  # convert dataframe into list of dataframes, where each list entry is one strata
  dfs <- list()  
  for(strata_name in names_of_strata){
    dfs[[strata_name]] <- dplyr::filter(df, strata==strata_name)
  }
  
  n <- sapply(dfs, nrow)  #  number of rows of data for each strata
  
  
  # Need to convert time series into stair-step. 
  ys <- sapply(n, function(x) rep(1:x, each = 2)[-2*x])  # doubled-up except for last time point
  xs <- sapply(n, function(x) c(1, rep(2:x, each = 2)))  # doubled-up except for first time-point
  
  if (num_of_strata == 1){  # if no strata will default to matrix, but has to be named list for later steps
    xs <- list(xs)
    names(xs) <- strata_name_if_no_strata
    ys <- list(ys)
    names(ys) <- strata_name_if_no_strata
  }
  
  
  # reconstruct data frames with the stair-stepped data
  for(strata_name in names_of_strata){
    dfs[[strata_name]] <- data.frame(x = dfs[[strata_name]]$time[xs[[strata_name]]], 
                                     y = dfs[[strata_name]]$surv[ys[[strata_name]]],
                                     up = dfs[[strata_name]]$upper[ys[[strata_name]]],
                                     low = dfs[[strata_name]]$lower[ys[[strata_name]]],
                                     dfs[[strata_name]][xs[[strata_name]], setdiff(names(dfs[[strata_name]]), c("x", "y"))])
  }
  
  create_ribbon_max <- function(df){
    # reorders "up" column (i.e. the upper confidence limit) so that the ribbons algorithm draws correctly.
    # Otherwise it draws over/underlapping triangles etc.
    a <- df$up[2:length(df$up)]   # swap order of every pair (after first entry) so that ribbon drawing works!
    b <- a
    b[c(T, F)] <- a[c(F,T)]
    b[c(F, T)] <- a[c(T,F)]
    df$up <- c(df$up[1], b)
    return(df)
  }
  
  dfs <- lapply(dfs, create_ribbon_max)
  
  
  # combine all the dataframes for each strata back into one, now that they have been stair-stepped
  dfALL <- dplyr::bind_rows(dfs)  %>% 
    dplyr::arrange(strata)
  
  censored <- dplyr::filter(dfALL, n.censor>0)  #  dataframe of all the censor events
  
  
  if(plot_CIs != TRUE){
    CI_opacity <- 0
    showlegend_CI <- FALSE
  }
  
  
  # create the plot_ly object
  p <- plotly::plot_ly(dfALL, 
                       split=~strata, 
                       colors=strata_colours, 
                       hoverinfo="y", 
                       legendgroup=~strata, 
                       text=~strata)  %>%
    # draw the survival plots
    plotly::add_lines(x=~x, y=~y * 100, color=~strata,
                      name=~strata,
                      legendgroup=~strata,
                      showlegend=showlegend_surv) %>%
    # draw the confidence intervals
    plotly::add_ribbons(x=~x, ymin=~(low*100), ymax=~ (up*100), color=~strata, 
                        opacity=CI_opacity, 
                        line=list(width=CI_linewidth),
                        name=~strata,
                        showlegend=showlegend_CI,
                        legendgroup=~strata,
                        hoverinfo="none")  %>%
    # draw the censor marks
    plotly::add_markers(x=~x, y=~ y, color=~strata, data=censored, 
                        marker=list(symbol=censor_symbol, size=censor_size),
                        name=~strata,
                        showlegend=showlegend_censor,
                        legendgroup=~strata,
                        hoverinfo="none") %>%
    plotly::layout(title=plot_title, 
                   showlegend=showlegend_all,
                   xaxis=xaxis, 
                   yaxis=yaxis,
                   legend=legend)
  
  return(p)
  
}


```



```{r, echo=FALSE,warning=FALSE,message=FALSE}

df <- read_csv("D:/opcab/opcab_paper/long_term_results/dataset_latest.csv")


# make the survival time to years.

df$surv_years <- (1 + df$survival_days) / 365.24


# figure 1A. KM plot for survival for the whole group.

df$opcab <- factor(df$opcab, levels = c(0,1),
                   labels = c("ONCAB","OPCAB"))



s <- survfit(Surv(surv_years, died) ~ opcab, data = df)


p <- ggsurvplot(s,
    data = df,
    risk.table = T,
    conf.int = T,
    break.x.by = 1,
    xlim = c(0, 10),
    palette = c("blue","red"),
    surv.scale = "percent",
    legend.labs = c("ONCAB", "OPCAB"))


p2 <- plotly_survival(p,strata_colours = c("blue","red"),plot_CIs = T,showlegend_all = F)

p3 <- p2 %>% 
  layout(xaxis = list(title = 'Follow-up Years', range = c(0,10))) %>%
  layout(yaxis = list(title = "Survival"))

p3

```

This figure panel presents the survival (with 95% confidence interval bands) for OPCAB and ONCAB patients in the entire cohort. red = OPCAB , blue = ONCAB.



```{r, echo=FALSE,message=FALSE,warning=FALSE}


df_m <- read_csv("D:\\opcab\\opcab_paper\\propensity_model\\prop_match_data.csv")



# now this is the propensity matched dataset.

df_m$surv_years <- (1 + df_m$survival_days) / 365.24

df_m$opcab <- factor(df_m$opcab,
                     levels = c(0,1),
                     labels = c("ONCAB","OPCAB"))

s_m <- survfit(Surv(surv_years, died) ~ opcab, data = df_m)

m <- ggsurvplot(s_m,
    data = df,
    risk.table = T,
    conf.int = T,
    break.x.by = 1,
    xlim = c(0, 10),
    palette = c("blue","red"),
    surv.scale = "percent",
    legend.labs = c("ONCAB", "OPCAB")
)


```

<u>Figure 2B:</u>

```{r, echo=FALSE,warning=FALSE,message=FALSE}

m2 <- plotly_survival(m,strata_colours = c("blue","red"),plot_CIs = T,showlegend_all = F)

m3 <- m2 %>% 
  layout(xaxis = list(title = 'Follow-up Years', range = c(0,10))) %>%
  layout(yaxis = list(title = "Survival"))

m3


```


This figure panel presents the survival (with 95% confidence interval bands) for OPCAB and ONCAB patients in the matched groups, calculated using the Kaplan-Meier method. Blue = ONCAB, Red = OPCAB

```{r, echo = F, message = F, warning=FALSE}

d = read_csv("D:/opcab/opcab_paper/propensity_model/data_dc.csv")

d = d %>% rename(
  Prematch = Diff.Un,
  Postmatch = Diff.Adj
)



d2 = d %>% pivot_longer(!Variable,
                  names_to = "type")

d2$Variable = factor(d2$Variable, ordered = T)


d2$value = round(d2$value,3)
```



<u>Supplemental Section</u>

<u>Supplemental Figure 1:</u>


```{r, warning=F, message=F,echo=F}

a = ggplot(data = d2, aes(x = value, y = Variable, group = type,
                      color = type)) + 
  
  geom_point(size = 2) + 
  geom_vline(xintercept = 0.1, col = "red", linetype = 2) + 
  geom_vline(xintercept = -0.1, col = "red", linetype = 2) +
  ylab(" ") + xlab("Standardised Difference value") + theme_clean() + scale_color_brewer() +
  geom_vline(xintercept = 0, col = "blue", linetype = 2)

a2 = a + theme_clean()  + theme(legend.title = element_blank()) + 

  scale_x_continuous(breaks = c(-0.2,-0.1,0,0.1,0.2,0.3,0.4)) +
    theme(text=element_text(family="Arial", size = 12)) +
  scale_color_manual(values = c("black","gray"))

p <- ggplotly(a2)

p2 <- ggplotly(a2,
               tooltip = c("value", 'Variable')) %>%  
  
  add_annotations( text="Legend", xref="paper", yref="paper",
                  x=1.02, xanchor="left",
                  y=0.8, yanchor="bottom",    # Same y as legend below
                  legendtitle=TRUE, showarrow=FALSE ) %>%
  layout( legend=list(y=0.8, yanchor="top" ) )

p2

```

This figure demonstrates the standardized difference  for each co-variate in the propensity score model. The gray dots represent the entire cohort, and the black dots represent the 1:1 matched pairs cohort. After matching, standardized difference for each covariate is between -0.1 and 0.1 demonstrating acceptable model balance.  The variable “distance” on the graphic represents the distance between propensity scores for patients. BMI body mass index; CAD coronary artery disease; COPD Chronic obstructive pulmonary disease; ESRD end-stage renal disease; HTN arterial hypertension; LMCA left main coronary artery; LVEF left ventricular ejection fraction; PAD peripheral artery disease; MI myocardial infarction; OHS open heart surgery; PS propensity score. 



